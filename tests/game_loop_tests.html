<body style="margin:0;pading:0">
<canvas id="visible_canvas"></canvas>
<script src="http://localhost:4000/socket.io/socket.io.js"></script>
<script>

"use strict"

onload = function ()
{
	window.is_logged = false;
	window.W = visible_canvas.width = innerWidth;
	window.H = visible_canvas.height = innerHeight;
	window.hW = W >> 1;
	window.hH = H >> 1;
	window.visible_ctx = visible_canvas.getContext("2d");
	window.buffer_canvas = visible_canvas.cloneNode();
	window.buffer_ctx = buffer_canvas.getContext("2d");
	window.my_player = {
		x: 0,
		y: 0,
		dir: 0,
		upgrades: null
	}
	window.mouse = {
		x: 0,
		y: 0,
		is_down: false
	}

	init_ws();
	t_login("azerty127");
	init_my_player();

	render_loop();
}

function init_ws ()
{
	window.socket = io.connect("http://localhost:4000");

	// ------------ emit ------------ //

	window.t_login = function (pseudo)
	{
		socket.emit("login", pseudo);
	}

	window.t_distance = function (dist)
	{
		socket.emit("distance", dist);
	}

	window.t_stop = function (is_stop)
	{
		socket.emit("stop", is_stop);
	}

	window.t_inputs = function (direction, is_pulsing)
	{
		var data = {
			direction: direction,
			pulse: is_pulsing
		};

		socket.emit("inputs", data);
	}

	window.t_upgrade = function (upgrade_id, upgrade_choice_id)
	{
		var data = {
			upgrade: upgrade_id,
			choice: upgrade_choice_id
		};

		socket.emit("upgrade", data);
	}

	// ------------ on ------------ //

	socket.on("err", function (err)
	{
		console.error("err:", err);
	});

	socket.on("upgrades", function (data)
	{
		console.log("upgrades:", data);

		is_logged = true;

		my_player.upgrades = data;
	});

	socket.on("update", function (data)
	{
		console.log("update:", data);
	});
}

function init_my_player ()
{
	if (!is_logged)
	{
		return setTimeout(init_my_player, 200); // wait
	}

	t_distance(Math.sqrt(hW * hW + hH * hH));
	t_stop(false);
}

function render_loop ()
{
	requestAnimationFrame(render_loop);

	// ---- update ---- //

	my_player.dir = Math.atan2(mouse.y - my_player.y, mouse.x - my_player.x);

	t_inputs(my_player.dir, mouse.is_down);

	// ---- render ---- //

	buffer_ctx.fillStyle = "#000";
	buffer_ctx.fillRect(0, 0, W, H);

	//buffer_ctx.fillStyle = p.color; // in a loop

	visible_ctx.drawImage(buffer_canvas, 0, 0);
}

onmousemove = function (e)
{
	mouse.x = e.clientX;
	mouse.y = e.clientY;
}

onmousedown = function (e)
{
	mouse.is_down = true;
}

onmouseup = function (e)
{
	mouse.is_down = false;
}

</script>
</body>
